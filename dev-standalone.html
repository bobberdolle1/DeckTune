<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DeckTune - Standalone Dev Mode</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <style>
        * {
            box-sizing: border-box;
        }
        body {
            margin: 0;
            padding: 0;
            font-family: 'Motiva Sans', Arial, sans-serif;
            background: linear-gradient(to bottom, #1b2838 0%, #2a475e 100%);
            color: #c7d5e0;
            min-height: 100vh;
        }
        .steam-deck-ui {
            max-width: 1280px;
            margin: 0 auto;
            padding: 20px;
        }
        .plugin-header {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .plugin-header h1 {
            margin: 0 0 10px 0;
            font-size: 28px;
            color: #fff;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .plugin-header .status {
            font-size: 12px;
            padding: 4px 12px;
            background: #4caf50;
            border-radius: 4px;
            font-weight: bold;
        }
        .plugin-header p {
            margin: 0;
            color: #8b929a;
            font-size: 14px;
        }
        .plugin-content {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        #root {
            min-height: 400px;
        }
        
        /* Steam Deck UI styling */
        .decktune-plugin {
            color: #c7d5e0;
        }
        
        button {
            background: linear-gradient(to bottom, #47bfff 5%, #1a44c2 60%);
            border: 1px solid #417a9b;
            border-radius: 3px;
            color: #fff;
            cursor: pointer;
            font-size: 14px;
            padding: 10px 20px;
            text-shadow: 0 1px 0 rgba(0, 0, 0, 0.5);
            transition: all 0.2s;
        }
        
        button:hover {
            background: linear-gradient(to bottom, #67cfff 5%, #2a54d2 60%);
        }
        
        button:active {
            transform: translateY(1px);
        }
        
        input[type="range"] {
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            outline: none;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            appearance: none;
            width: 16px;
            height: 16px;
            background: #47bfff;
            border-radius: 50%;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="steam-deck-ui">
        <div class="plugin-header">
            <h1>
                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M14.6,16.6l4.6-4.6c0.8-0.8,0.8-2,0-2.8c-0.8-0.8-2-0.8-2.8,0l-4.6,4.6L7.2,9.2c-0.8-0.8-2-0.8-2.8,0 c-0.8,0.8-0.8,2,0,2.8l4.6,4.6l-4.6,4.6c-0.8,0.8-0.8,2,0,2.8c0.4,0.4,0.9,0.6,1.4,0.6s1-0.2,1.4-0.6l4.6-4.6l4.6,4.6 c0.4,0.4,0.9,0.6,1.4,0.6s1-0.2,1.4-0.6c0.8-0.8,0.8-2,0-2.8L14.6,16.6z"/>
                </svg>
                DeckTune
                <span class="status">DEV MODE</span>
            </h1>
            <p>Standalone development environment with mock backend</p>
        </div>
        
        <div class="plugin-content">
            <div id="root"></div>
        </div>
    </div>

    <script>
        // Mock Decky globals
        window.SP_REACT = React;
        window.SP_REACTDOM = ReactDOM;
        
        // Mock Decky internal API connection (CRITICAL)
        window.__DECKY_SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED_deckyLoaderAPIInit = {
            connect: (apiVersion, pluginName) => {
                console.log(`[MOCK] Decky API connected: v${apiVersion}, plugin: ${pluginName}`);
                
                return {
                    call: async (method, ...args) => {
                        console.log(`[MOCK RPC] ${method}`, args);
                        
                        // Mock responses for common RPC calls
                        const responses = {
                            'get_config': {
                                cores: [-20, -20, -20, -20],
                                status: 'disabled',
                                lkg_cores: [-20, -20, -20, -20],
                                lkg_timestamp: new Date().toISOString(),
                                settings: {
                                    isGlobal: false,
                                    runAtStartup: false,
                                    isRunAutomatically: true,
                                    timeoutApply: 15
                                },
                                dynamicSettings: {
                                    cores: [
                                        { manualPoints: [], maximumValue: 100, minimumValue: 0, threshold: 0 },
                                        { manualPoints: [], maximumValue: 100, minimumValue: 0, threshold: 0 },
                                        { manualPoints: [], maximumValue: 100, minimumValue: 0, threshold: 0 },
                                        { manualPoints: [], maximumValue: 100, minimumValue: 0, threshold: 0 }
                                    ],
                                    strategy: 'DEFAULT',
                                    sampleInterval: 50000
                                },
                                expert_mode: false,
                                simple_mode: false,
                                presets: [],
                                test_history: []
                            },
                            'fetch_config': {
                                cores: [-20, -20, -20, -20],
                                status: 'disabled',
                                lkg_cores: [-20, -20, -20, -20],
                                lkg_timestamp: new Date().toISOString(),
                                settings: {
                                    isGlobal: false,
                                    runAtStartup: false,
                                    isRunAutomatically: true,
                                    timeoutApply: 15
                                },
                                dynamicSettings: {
                                    cores: [
                                        { manualPoints: [], maximumValue: 100, minimumValue: 0, threshold: 0 },
                                        { manualPoints: [], maximumValue: 100, minimumValue: 0, threshold: 0 },
                                        { manualPoints: [], maximumValue: 100, minimumValue: 0, threshold: 0 },
                                        { manualPoints: [], maximumValue: 100, minimumValue: 0, threshold: 0 }
                                    ],
                                    strategy: 'DEFAULT',
                                    sampleInterval: 50000
                                },
                                expert_mode: false,
                                simple_mode: false,
                                presets: [],
                                test_history: []
                            },
                            'init': { success: true },
                            'check_wizard_dirty_exit': { dirty: false },
                            'get_wizard_results_history': { results: [] },
                            'get_platform_info': { platform: 'Galileo (OLED)', model: 'Steam Deck OLED' },
                            'get_test_history': { history: [] },
                            'apply_undervolt': { success: true },
                            'disable_undervolt': { success: true },
                            'get_platform': { platform: 'Galileo (OLED)', model: 'Steam Deck OLED' }
                        };
                        
                        // Simulate network delay
                        await new Promise(resolve => setTimeout(resolve, 100));
                        
                        return responses[method] || {};
                    },
                    
                    callable: {},
                    
                    addEventListener: (event, callback) => {
                        console.log(`[MOCK] addEventListener: ${event}`);
                        return () => console.log(`[MOCK] removeEventListener: ${event}`);
                    },
                    
                    removeEventListener: (event, callback) => {
                        console.log(`[MOCK] removeEventListener: ${event}`);
                    },
                    
                    routerHook: {
                        addRoute: () => {},
                        removeRoute: () => {}
                    },
                    
                    toaster: {
                        toast: (message) => console.log('[MOCK TOAST]', message)
                    },
                    
                    openFilePicker: async () => ({ path: '/mock/path' }),
                    executeInTab: async () => {},
                    injectCssIntoTab: async () => {},
                    removeCssFromTab: async () => {},
                    fetchNoCors: async (url) => fetch(url),
                    getExternalResourceURL: (path) => `http://localhost:8080/${path}`
                };
            }
        };
        
        // Mock Decky API
        const mockServerAPI = {
            callPluginMethod: async (method, args) => {
                console.log(`[MOCK RPC] ${method}`, args);
                
                // Mock responses for common RPC calls
                const responses = {
                    'get_config': {
                        success: true,
                        result: {
                            cores: [-20, -20, -20, -20],
                            status: 'disabled',
                            lkg_cores: [-20, -20, -20, -20],
                            lkg_timestamp: new Date().toISOString(),
                            settings: {
                                isGlobal: false,
                                runAtStartup: false,
                                isRunAutomatically: true,
                                timeoutApply: 15
                            },
                            dynamicSettings: {
                                cores: [
                                    { manualPoints: [], maximumValue: 100, minimumValue: 0, threshold: 0 },
                                    { manualPoints: [], maximumValue: 100, minimumValue: 0, threshold: 0 },
                                    { manualPoints: [], maximumValue: 100, minimumValue: 0, threshold: 0 },
                                    { manualPoints: [], maximumValue: 100, minimumValue: 0, threshold: 0 }
                                ],
                                strategy: 'DEFAULT',
                                sampleInterval: 50000
                            },
                            expert_mode: false,
                            simple_mode: false,
                            presets: [],
                            test_history: []
                        }
                    },
                    'apply_undervolt': {
                        success: true,
                        result: { success: true }
                    },
                    'disable_undervolt': {
                        success: true,
                        result: { success: true }
                    },
                    'get_platform': {
                        success: true,
                        result: { platform: 'Galileo (OLED)', model: 'Steam Deck OLED' }
                    }
                };
                
                // Simulate network delay
                await new Promise(resolve => setTimeout(resolve, 100));
                
                return responses[method] || { success: true, result: {} };
            },
            
            addEventListener: (event, callback) => {
                console.log(`[MOCK] addEventListener: ${event}`);
                return () => console.log(`[MOCK] removeEventListener: ${event}`);
            },
            
            removeEventListener: (event, callback) => {
                console.log(`[MOCK] removeEventListener: ${event}`);
            }
        };
        
        // Mock @decky/api
        window.deckyAPI = {
            serverAPI: mockServerAPI,
            definePlugin: (factory) => {
                console.log('[MOCK] definePlugin called');
                const plugin = factory();
                console.log('[MOCK] Plugin definition:', plugin);
                
                // Render the plugin content
                if (plugin.content) {
                    const root = document.getElementById('root');
                    const reactRoot = ReactDOM.createRoot(root);
                    reactRoot.render(plugin.content);
                    console.log('[MOCK] Plugin content rendered');
                }
                
                return plugin;
            }
        };
        
        // Mock Decky Frontend Library (DFL)
        window.DFL = {
            PanelSection: ({ title, children }) => {
                return React.createElement('div', { 
                    style: { 
                        background: 'rgba(0, 0, 0, 0.3)', 
                        padding: '15px', 
                        borderRadius: '8px',
                        marginBottom: '15px',
                        border: '1px solid rgba(255, 255, 255, 0.1)'
                    }
                }, [
                    title && React.createElement('h3', { 
                        key: 'title',
                        style: { 
                            margin: '0 0 15px 0', 
                            fontSize: '18px',
                            color: '#fff',
                            fontWeight: '600'
                        }
                    }, title),
                    React.createElement('div', { key: 'content' }, children)
                ]);
            },
            
            PanelSectionRow: ({ children }) => {
                return React.createElement('div', { 
                    style: { 
                        padding: '10px 0',
                        borderBottom: '1px solid rgba(255, 255, 255, 0.05)'
                    }
                }, children);
            },
            
            ButtonItem: ({ children, onClick, disabled }) => {
                return React.createElement('button', {
                    onClick,
                    disabled,
                    style: {
                        background: disabled ? '#555' : 'linear-gradient(to bottom, #47bfff 5%, #1a44c2 60%)',
                        color: '#fff',
                        border: '1px solid #417a9b',
                        padding: '12px 20px',
                        borderRadius: '3px',
                        cursor: disabled ? 'not-allowed' : 'pointer',
                        fontSize: '14px',
                        width: '100%',
                        textAlign: 'left',
                        fontWeight: '500'
                    }
                }, children);
            },
            
            SliderField: ({ label, value, min, max, step, onChange, disabled }) => {
                return React.createElement('div', {
                    style: { marginBottom: '15px' }
                }, [
                    React.createElement('div', { 
                        key: 'label',
                        style: { 
                            display: 'flex',
                            justifyContent: 'space-between',
                            marginBottom: '8px',
                            fontSize: '14px',
                            color: '#c7d5e0'
                        }
                    }, [
                        React.createElement('span', { key: 'text' }, label),
                        React.createElement('span', { 
                            key: 'value',
                            style: { 
                                color: '#47bfff',
                                fontWeight: '600'
                            }
                        }, `${value}mV`)
                    ]),
                    React.createElement('input', {
                        key: 'slider',
                        type: 'range',
                        min,
                        max,
                        step: step || 1,
                        value,
                        disabled,
                        onChange: (e) => onChange(parseInt(e.target.value)),
                        style: { width: '100%' }
                    })
                ]);
            },
            
            ToggleField: ({ label, checked, onChange, disabled }) => {
                return React.createElement('div', {
                    style: { 
                        display: 'flex', 
                        justifyContent: 'space-between',
                        alignItems: 'center',
                        padding: '12px 0',
                        fontSize: '14px'
                    }
                }, [
                    React.createElement('span', { key: 'label', style: { color: '#c7d5e0' } }, label),
                    React.createElement('input', {
                        key: 'toggle',
                        type: 'checkbox',
                        checked,
                        disabled,
                        onChange: (e) => onChange(e.target.checked),
                        style: { 
                            width: '44px', 
                            height: '24px',
                            cursor: disabled ? 'not-allowed' : 'pointer'
                        }
                    })
                ]);
            },
            
            Focusable: ({ children, ...props }) => {
                return React.createElement('div', { 
                    ...props,
                    tabIndex: 0,
                    style: { outline: 'none', ...props.style }
                }, children);
            },
            
            Router: {
                MainRunningApp: null
            }
        };

        console.log('[DEV MODE] Mock environment initialized');
        console.log('[DEV MODE] serverAPI:', mockServerAPI);
    </script>

    <script type="module">
        // Import the plugin module
        import pluginFactory from './dist/index.js';
        
        console.log('[DEV MODE] Plugin factory imported');
        
        // Execute the plugin factory to get the plugin definition
        const plugin = pluginFactory();
        
        console.log('[DEV MODE] Plugin initialized:', plugin);
        
        // Render the plugin content
        if (plugin && plugin.content) {
            const root = document.getElementById('root');
            if (root && window.SP_REACTDOM) {
                console.log('[DEV MODE] Rendering plugin content...');
                const reactRoot = window.SP_REACTDOM.createRoot(root);
                reactRoot.render(plugin.content);
                console.log('[DEV MODE] Plugin content rendered successfully');
            } else {
                console.error('[DEV MODE] Missing root element or ReactDOM');
            }
        } else {
            console.error('[DEV MODE] Plugin has no content to render');
        }
    </script>
</body>
</html>
